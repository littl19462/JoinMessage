name: Build and Release Plugin

# æƒé™è®¾ç½® - ç¡®ä¿æ‰€æœ‰æ“ä½œæœ‰è¶³å¤Ÿæƒé™
permissions:
  contents: write   # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  issues: write     # å…è®¸åˆ›å»º Issue è¯„è®º
  pull-requests: write # å…è®¸åˆ›å»º PR è¯„è®º
  actions: read     # å…è®¸è¯»å–å·¥ä½œæµçŠ¶æ€

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # æ‰‹åŠ¨è§¦å‘é…ç½® - å…è®¸é€šè¿‡ UI æˆ– API æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦æ„å»ºçš„æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯• (true/false)'
        required: false
        default: 'false'
        type: boolean
      
  # è‡ªåŠ¨è§¦å‘é…ç½® - æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'

# ä½œä¸šå®šä¹‰
jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    timeout-minutes: 25  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    # ç¯å¢ƒå˜é‡
    env:
      MAVEN_OPTS: -Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=${{ github.workspace }}/.m2/repository
    
    steps:
    # ================ åˆå§‹åŒ–é˜¶æ®µ ================
    - name: Checkout code
      uses: actions/checkout@v4.1.1
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        ref: ${{ github.event.inputs.tag || github.ref }}  # æ”¯æŒæ‰‹åŠ¨æŒ‡å®šæ ‡ç­¾
    
    # ================ ç¯å¢ƒè®¾ç½®é˜¶æ®µ ================
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Set up Maven
      uses: stCarolas/setup-maven@v1.6.0
      with:
        maven-version: 3.8.6
        
    - name: Verify project structure
      run: |
        echo "å·¥ä½œç›®å½•: ${{ github.workspace }}"
        ls -la
        if [ ! -f "pom.xml" ]; then
          echo "âŒ é”™è¯¯: pom.xml æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          exit 1
        fi
        
    # ================ ç‰ˆæœ¬å¤„ç†é˜¶æ®µ ================
    - name: Determine version
      id: version-step
      run: |
        # æ‰‹åŠ¨è¿è¡Œæ—¶ä½¿ç”¨è¾“å…¥å‚æ•°
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          VERSION=${{ github.event.inputs.tag }}
        else
          # è‡ªåŠ¨è§¦å‘æ—¶ä»æ ‡ç­¾æå–
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        
        # æ¸…ç†ç‰ˆæœ¬å·ï¼ˆç§»é™¤å¯èƒ½çš„å‰ç¼€ï¼‰
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//i')
        echo "RELEASE_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
        echo "MAVEN_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
        echo "ä½¿ç”¨ç‰ˆæœ¬: $CLEAN_VERSION"
        
        # è®¾ç½®è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
    
    # ================ æ„å»ºé˜¶æ®µ ================
    - name: Set Maven version
      run: |
        echo "æ­£åœ¨è®¾ç½® Maven ç‰ˆæœ¬: ${{ env.MAVEN_VERSION }}"
        mvn -B versions:set -DnewVersion=${{ env.MAVEN_VERSION }} -DgenerateBackupPoms=false
        echo "ç‰ˆæœ¬è®¾ç½®å®Œæˆ"
        
    - name: Build plugin with Maven
      run: |
        # æ ¹æ®è¾“å…¥å†³å®šæ˜¯å¦è·³è¿‡æµ‹è¯•
        BUILD_CMD="mvn -B clean package"
        
        if [ "${{ inputs.skip_tests }}" = "true" ]; then
          BUILD_CMD="$BUILD_CMD -DskipTests"
          echo "è·³è¿‡æµ‹è¯•"
        fi
        
        echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: $BUILD_CMD"
        $BUILD_CMD
        
        # éªŒè¯æ„å»ºç»“æœ
        if [ ! -f "target/JoinMessage-${{ env.MAVEN_VERSION }}.jar" ]; then
          echo "âŒ é”™è¯¯: JAR æ–‡ä»¶æœªç”Ÿæˆï¼"
          exit 1
        fi
        
        echo "âœ… æ„å»ºæˆåŠŸ"
      
    # ================ å‘å¸ƒé˜¶æ®µ ================
    - name: Verify artifacts
      run: |
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la target/
        
        JAR_FILE="target/JoinMessage-${{ env.MAVEN_VERSION }}.jar"
        if [ ! -f "$JAR_FILE" ]; then
          echo "âŒ é”™è¯¯: ä¸» JAR æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        JAR_SIZE=$(wc -c < "$JAR_FILE")
        MIN_SIZE=50000  # 50KB
        
        if [ "$JAR_SIZE" -lt $MIN_SIZE ]; then
          echo "âŒ é”™è¯¯: JAR æ–‡ä»¶è¿‡å° (${JAR_SIZE} å­—èŠ‚)ï¼Œå¯èƒ½æ„å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… äº§ç‰©éªŒè¯é€šè¿‡ (å¤§å°: ${JAR_SIZE} å­—èŠ‚)"
      
    - name: Create GitHub Release
      id: create-release
      uses: softprops/action-gh-release@v2.8.0
      with:
        files: |
          target/*.jar
        name: JoinMessage ${{ env.RELEASE_VERSION }}
        tag_name: v${{ env.RELEASE_VERSION }}
        body: |
          ## JoinMessage ${{ env.RELEASE_VERSION }}
          
          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹é¢çš„ JAR æ–‡ä»¶
          2. æ”¾å…¥æœåŠ¡å™¨çš„ `plugins` æ–‡ä»¶å¤¹
          3. é‡å¯æœåŠ¡å™¨
          
          ### æ„å»ºä¿¡æ¯
          - **æ—¥æœŸ**: ${{ steps.date.outputs.current_date }}
          - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          [æŸ¥çœ‹å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ================ æˆåŠŸé€šçŸ¥ ================
    - name: Success Notification
      if: success()
      run: |
        echo "âœ… å‘å¸ƒæˆåŠŸ: JoinMessage v${{ env.RELEASE_VERSION }}"
        echo "ä¸‹è½½åœ°å€: ${{ steps.create-release.outputs.html_url }}"
        
    # ================ å¤±è´¥å¤„ç†é˜¶æ®µ ================
    - name: Get current date
      if: failure()
      id: date
      run: echo "current_date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
    - name: Notify on Failure
      if: failure()
      run: |
        # å‡†å¤‡é”™è¯¯ä¿¡æ¯
        ERROR_MSG="ğŸš¨ **å‘å¸ƒå¤±è´¥**: JoinMessage v${{ env.RELEASE_VERSION }}"
        ERROR_MSG+="\n\n**ä»“åº“**: ${{ github.repository }}"
        ERROR_MSG+="\n**å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        ERROR_MSG+="\n**æ—¶é—´**: ${{ steps.date.outputs.current_date }}"
        ERROR_MSG+="\n\n### é”™è¯¯è¯¦æƒ…"
        ERROR_MSG+="\nè¯·æŸ¥çœ‹ [å·¥ä½œæµæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–è¯¦ç»†ä¿¡æ¯"
        
        # åˆ›å»º Issue
        if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
          echo "åˆ›å»ºé—®é¢˜æŠ¥å‘Š..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -d '{
              "title": "Release v${{ env.RELEASE_VERSION }} Failed",
              "body": "'"${ERROR_MSG}"'",
              "labels": ["bug", "release-failed"]
            }'
        else
          echo "GITHUB_TOKEN ä¸å¯ç”¨ï¼Œæ— æ³•åˆ›å»ºé—®é¢˜"
        fi
        
        # è¾“å‡ºåˆ°æ—¥å¿—
        echo -e "\n\n$ERROR_MSG"
        
        # ç¡®ä¿å·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥
        exit 1

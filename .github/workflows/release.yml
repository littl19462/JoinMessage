name: Build and Release Plugin

on:
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘æ”¯æŒ
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦æ„å»ºçš„æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
  
  # ä¿ç•™åŸæœ‰çš„è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # æ·»åŠ è¶…æ—¶è®¾ç½®
    timeout-minutes: 15
    
    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰
    - name: Checkout code with tags
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        ref: ${{ github.ref }}
      
    # 2. è®¾ç½®Javaç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    # 3. ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·
    - name: Extract version from tag
      id: extract-version
      run: |
        # æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹ v1.0.0 å’Œ v1.0ï¼‰
        VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
        echo "Using version: $VERSION"
        
    # 4. è®¾ç½®Mavenç‰ˆæœ¬
    - name: Set Maven version
      run: |
        mvn versions:set -DnewVersion=${{ env.RELEASE_VERSION }}
        
    # 5. æ„å»ºæ’ä»¶
    - name: Build plugin with Maven
      run: mvn -B clean package
      
    # 6. éªŒè¯æ„å»ºäº§ç‰©
    - name: Verify artifacts
      run: |
        echo "Generated files:"
        ls -la target/
        if [ ! -f "target/JoinMessage-${{ env.RELEASE_VERSION }}.jar" ]; then
          echo "ERROR: JAR file not found!"
          exit 1
        fi
      
    # 7. åˆ›å»ºGitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          target/*.jar  # ä½¿ç”¨é€šé…ç¬¦ç¡®ä¿åŒ¹é…
        name: JoinMessage ${{ env.RELEASE_VERSION }}
        tag_name: v${{ env.RELEASE_VERSION }}
        body: |
          ## JoinMessage ${{ env.RELEASE_VERSION }}
          
          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½ JAR æ–‡ä»¶
          2. æ”¾å…¥æœåŠ¡å™¨çš„ `plugins` æ–‡ä»¶å¤¹
          3. é‡å¯æœåŠ¡å™¨
          
          [æŸ¥çœ‹å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }})
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # 8. å¤±è´¥é€šçŸ¥
    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const message = `ğŸš¨ å‘å¸ƒå¤±è´¥: ${{ github.repository }}@v${{ env.RELEASE_VERSION }}`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
